function Reader(){this.initialize()}function AMRender(){var u=new Reader;document.open(),document.write(u.renderedHTML),setTimeout(function(){u.finalize()},500)}Reader.prototype.initialize=function(){var u=/.*[#&]storyID=([^&$]+).*/.exec(window.location.hash),e=/.*[#&]issueID=([^&$]+).*/.exec(window.location.hash),t=/.*[#&]fontSize=([^&$]+).*/.exec(window.location.hash),E=/.*[#&]tocID=([^&$]+).*/.exec(window.location.hash),s=/.*[#&]cache=([^&$]+).*/.exec(window.location.hash),a=/.*[#&]mode=([^&$]+).*/.exec(window.location.hash),r=/.*[#&]orientation=([^&$]+).*/.exec(window.location.hash),l=/.*[#&]navigate=([^&$]+).*/.exec(window.location.hash),F=/.*[#&]platform=([^&$]+).*/.exec(window.location.hash),n=/.*[#&]path=([^&$]+).*/.exec(window.location.hash);this.issueID=e?e[1]:null,this.tocID=E?E[1]:null,this.storyId=u?u[1]:null,this.textSize=t?t[1]:0,this.cache=s?s[1]:null,this.mode=a?a[1]:0,this.orientation=r?r[1]:"portrait",this.navigate=l?l[1]:"00",this.platform=F?F[1]:"tablet",this.path=n?n[1]:"",this.path.length>0&&(this.path=this.path.replace(/^\/+/,""),"/"!=this.path[this.path.length-1]&&(this.path+="/"));var i=this.fetchJSON("../"+this.path+this.issueID+"/properties.js");if(this.designPath="../"+this.path+"designs/"+i.layout.name,this.issueName="",void 0!==i.issue&&void 0!==i.issue.title&&(this.issueName=i.issue.title),null!=this.cache){var A=this.fetchHTML("../"+this.path+this.issueID+"/"+this.storyId+"/"+this.cache+".html");if(200==A.status||0==A.status){var o=A.responseText,C=document.implementation.createHTMLDocument("");C.open(),C.write(o),C.close();var D=C.body.classList[0];C.body.className=D+" mode-"+this.mode+" text-size-"+this.textSize+" "+this.platform,this.renderedHTML="<html>"+C.getElementsByTagName("html")[0].innerHTML+"</html>"}else this.cache=null}null==this.cache&&(this.properties=this.fetchJSON("../"+this.path+this.issueID+"/"+this.tocID+".js?123"),this.renderLayout())},Reader.prototype.renderLayout=function(){this.storyId?(story=this.findStory(this.storyId,this.properties),layout=story.layout!=[]&&0!=story.layout.length?story.layout[this.orientation].link:"portrait"==this.orientation?"default_layout_portrait.twig":"default_layout_landscape.twig"):(story=this.properties.section.stories,layout=this.properties.section[this.orientation+"_view"]);var u=document.createElement("div");u.innerHTML=story.body;var e=u.querySelectorAll("img");if(e.length>0){var t=e[0].parentNode;t.parentNode.removeChild(t)}if("H5"==u.children[0].nodeName){var E=u.children[0];E.parentNode.removeChild(E)}if("H2"==u.children[0].nodeName){var E=u.children[0];E.parentNode.removeChild(E)}for(var s=u.querySelectorAll(".deck"),a=s.length-1;a>=0;a--)s[a].parentNode.removeChild(s[a]);for(var r=u.querySelectorAll(".byline"),l="",a=r.length-1;a>=0;a--)l+="<span>"+r[a].innerText+"</span>&nbsp;",r[a].parentNode.removeChild(r[a]);story.byline=l,e=u.querySelectorAll("img");for(var a=0;a<e.length;a++){var F=e[a];F.parentNode.className="image";var n=F.getAttribute("src");if(n.indexOf(this.storyId)<0&&n.indexOf("http")<0){var i=n.split("/"),A=i[i.length-1];n="../"+this.path+this.issueID+"/"+this.storyId+"/"+A,F.setAttribute("src",n);var o=F.parentNode.querySelector("figcaption");if(null!=o){var C=F.parentNode;C.parentNode.insertBefore(o,C.nextSibling)}for(var D=0,c=!0;D<story.related_objects.image.length&&c;){var g=story.related_objects.image[D];g.image_url==A&&(g.width>199||g.height>199)&&(c=!1,F.setAttribute("data-rel","amreader:media/gallery:../"+this.path+this.issueID+"/"+this.storyId+"/"+g.id)),D++}}}for(var b=u.querySelectorAll("a"),a=0;a<b.length;a++){var f=b[a],d=f.getAttribute("href");f.setAttribute("data-rel","amreader:hyperlink/"+d)}story.body=u.innerHTML,story.galleryLink="../"+this.path+this.issueID+"/"+this.storyId,story.image.length>0&&(story.image="portrait"==this.orientation?story.image[0]:story.image[1],story.image.image_url="../"+this.path+this.issueID+"/"+this.storyId+"/"+story.image.image_url,story.defaultImageLink="../"+this.path+this.issueID+"/"+this.storyId+"/"+story.image.id),data={issue:{id:this.issueID,name:this.issueName},section:{color:this.properties.section.title_color,name:this.properties.section.section_name,description:this.properties.section.description},design:this.designPath,asset:"../"+this.path+this.issueID+"/"+this.storyId,fontSize:this.textSize,mode:this.mode,platform:this.platform,story:story};var B=new Date,p=B.getTime();twig({id:p,href:this.designPath+"/layouts/"+layout,async:!1}),this.renderedHTML=twig({ref:p}).render(data)},Reader.prototype.fetchJSON=function(u){var e=new XMLHttpRequest;return e.open("GET",u,!1),e.send(),JSON.parse(e.responseText,null)},Reader.prototype.fetchHTML=function(u){var e=new XMLHttpRequest;return e.open("GET",u,!1),e.send(),e},Reader.prototype.findStory=function(u,e){var t=jsel(e.section);return t.select("//stories/*[@id='"+u+"']")},Reader.prototype.finalize=function(){this.addEvent(),AMCustomScript(this.mode,this.textSize,this.navigate,this.cache),this.PostProcess(),window.addEventListener("hashchange",AMRender,!1)},Reader.prototype.addEvent=function(){var u=new Array;u=document.getElementsByTagName("*");for(var e=0,t=u.length;t>e;e++)(void 0==u[e].className||u[e].className.indexOf("custom-action")<0)&&u[e].addEventListener("click",this.URLHandler,!1)},Reader.prototype.PostProcess=function(){setTimeout(function(u){null!=u.cache?u.SendMessage("amreader:page-load-complete"):u.SendMessage("amreader:cache-request/pages:1/file:"+u.issueID+"/"+u.tocID+"/"+(u.storyId?u.storyId+"/":"")+"story_"+u.orientation+".html")},1e3,this)},Reader.prototype.URLHandler=function(u){u.preventDefault(),u.stopPropagation(),null!=u.srcElement.parentElement&&u.srcElement.parentElement.getAttribute("data-rel")?Reader.prototype.SendMessage(u.srcElement.parentElement.getAttribute("data-rel")):null!=u.srcElement.parentElement.parentElement&&u.srcElement.parentElement.parentElement.getAttribute("data-rel")?Reader.prototype.SendMessage(u.srcElement.parentElement.parentElement.getAttribute("data-rel")):u.srcElement.getAttribute("data-rel")?Reader.prototype.SendMessage(u.srcElement.getAttribute("data-rel")):Reader.prototype.SendMessage("amreader:clickBody")},Reader.prototype.SendMessage=function(u){var e;e=document.getElementById("amreader-iframe"),null==e&&document.body?(e=document.createElement("iframe"),e.style.display="none",e.style.width="1px",e.style.height="1px",e.style.position="absolute",e.style.left="-20px",e.style.top="0px",e.id="amreader-iframe",e.src=u,document.body.appendChild(e)):null!=e&&(e.src=u)},window.addEventListener("load",AMRender,!1);